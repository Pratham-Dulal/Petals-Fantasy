<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Himalayan Floriculture - Custom Builder</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2d4c1e;
            --accent: #d4af37;
            --bg-light: #f9f9f9;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: #f4f4f4;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Top Nav */
        .builder-header {
            height: 60px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .builder-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            flex: 1;
            height: calc(100vh - 60px);
        }

        /* Sidebar */
        .builder-sidebar {
            background: white;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .step-tabs {
            display: flex;
            padding: 1rem;
            gap: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .step-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            background: #f4f4f4;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .step-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(45, 76, 30, 0.2);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        /* Product Cards */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .option-card {
            background: white;
            border: 1px solid #eee;
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .option-card.selected {
            border-color: var(--primary);
            background: #fcfefc;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .option-img {
            width: 80px;
            height: 80px;
            background: #eee;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            background-size: cover;
            background-position: center;
        }

        /* Canvas Area */
        .builder-canvas-area {
            position: relative;
            background: radial-gradient(circle at center, #ffffff 0%, #e0e0e0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        canvas {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            /* Optional: Makes it look like a photo print */
        }

        /* Overlay Controls */
        .canvas-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 5;
            display: flex;
            gap: 10px;
        }

        /* Summary Bar */
        .builder-summary {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 2rem;
            width: 80%;
            max-width: 800px;
            justify-content: space-between;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.8rem;
            color: #888;
            display: block;
            margin-bottom: 2px;
        }

        .summary-val {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 76, 30, 0.3);
        }

        /* Loader */
        #loader {
            position: absolute;
            inset: 0;
            background: white;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>

<body>

    <header class="builder-header">
        <a href="index.html" class="btn btn-text"><i class="fa-solid fa-arrow-left"></i> Back</a>
        <h2 style="font-family:'Playfair Display'; margin:0;">Custom Bouquet Builder</h2>
        <div><!-- User Profile or Cart Icon --></div>
    </header>

    <div class="builder-layout">
        <!-- Sidebar -->
        <aside class="builder-sidebar">
            <div class="step-tabs">
                <button class="step-btn active" data-step="flowers">1. Flowers</button>
                <button class="step-btn" data-step="wrapping">2. Wrapping</button>
                <button class="step-btn" data-step="addons">3. Add-ons</button>
            </div>

            <div class="sidebar-content">
                <!-- Step 1: Flowers -->
                <div id="step-flowers" class="step-content active">
                    <h3>Choose Your Blooms</h3>
                    <p class="text-muted">Click to add flowers to your bouquet.</p>

                    <div class="option-grid">
                        <!-- Rose -->
                        <div class="option-card" onclick="builder.addFlower('rose', 300)">
                            <div class="option-img" style="background-image: url('assets/rose.png')"></div>
                            <h4>Red Rose</h4>
                            <p class="price">Rs. 300</p>
                        </div>
                        <!-- Lily -->
                        <div class="option-card" onclick="builder.addFlower('lily', 450)">
                            <div class="option-img" style="background-image: url('assets/lily.png')"></div>
                            <h4>White Lily</h4>
                            <p class="price">Rs. 450</p>
                        </div>
                        <!-- Sunflower -->
                        <div class="option-card" onclick="builder.addFlower('sunflower', 250)">
                            <div class="option-img" style="background-image: url('assets/sunflower.png')"></div>
                            <h4>Sunflower</h4>
                            <p class="price">Rs. 250</p>
                        </div>
                        <!-- Greenery (Reusing Lily/Rose logic for now or placeholder) -->
                        <div class="option-card" onclick="builder.addFlower('rose', 100)"> <!-- TODO: Greenery Asset -->
                            <div class="option-img" style="background-color: #5a7d4a"></div>
                            <h4>Greenery</h4>
                            <p class="price">Rs. 100</p>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Wrapping -->
                <div id="step-wrapping" class="step-content">
                    <h3>Select Wrapping</h3>
                    <div class="option-grid">
                        <div class="option-card selected" onclick="builder.setWrapper('kraft', 200)">
                            <div class="option-img" style="background: #d4a373;"></div>
                            <h4>Kraft Paper</h4>
                            <p class="price">Rs. 200</p>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Addons -->
                <div id="step-addons" class="step-content">
                    <h3>Finishing Touches</h3>
                    <div class="option-grid">
                        <div class="option-card" onclick="builder.toggleAddon('ribbon', 150)">
                            <div class="option-img" style="background: #900;"></div>
                            <h4>Satin Ribbon</h4>
                            <p class="price">Rs. 150</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="builder-canvas-area">

            <div id="loader">
                <i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                <p style="margin-top: 1rem;">Loading High-Res Assets...</p>
            </div>

            <div class="canvas-controls">
                <button class="btn-primary" onclick="builder.reset()"
                    style="background: white; color: #333; padding: 0.5rem 1rem; font-size: 0.9rem;">
                    <i class="fa-solid fa-rotate-right"></i> Reset
                </button>
            </div>

            <canvas id="bouquet-canvas" width="1200" height="1200"
                style="max-width: 100%; max-height: 90vh; width: auto; height: auto;"></canvas>

            <!-- Summary -->
            <div class="builder-summary">
                <div class="summary-item">
                    <span class="summary-label">Base</span>
                    <span class="summary-val" id="base-price">Rs. 200</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Flowers (<span id="count">0</span>)</span>
                    <span class="summary-val" id="flower-price">Rs. 0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total</span>
                    <span class="summary-val" id="total-price" style="color: var(--primary); font-size: 1.4rem;">Rs.
                        200</span>
                </div>
                <button class="btn-primary">Add to Cart</button>
            </div>
        </main>
    </div>

    <script>
        // --- 2D ENGINE START ---

        const canvas = document.getElementById('bouquet-canvas');
        const ctx = canvas.getContext('2d');

        // Asset Manager
        const ASSETS = {
            wrapper: { src: 'assets/wrapper.png', img: new Image() },
            rose: { src: 'assets/rose.png', img: new Image() },
            lily: { src: 'assets/lily.png', img: new Image() },
            sunflower: { src: 'assets/sunflower.png', img: new Image() }
        };

        // State
        const state = {
            flowers: [], // { type, x, y, rot, scale, zIndex }
            price: {
                base: 200,
                flowers: 0,
                addons: 0
            }
        };

        // Init
        let assetsLoaded = 0;
        const totalAssets = Object.keys(ASSETS).length;

        function checkLoad() {
            assetsLoaded++;
            if (assetsLoaded === totalAssets) {
                document.getElementById('loader').style.display = 'none';
                render();
            }
        }

        Object.values(ASSETS).forEach(asset => {
            asset.img.onload = checkLoad;
            asset.img.onerror = () => { console.error("Missing asset:", asset.src); checkLoad(); }; // Fail graceful
            asset.img.src = asset.src;
        });

        // --- Logic ---

        window.builder = {
            addFlower: (type, price) => {
                if (!ASSETS[type]) type = 'rose';

                // --- NEW ALGORITHM: Golden Spiral (Phyllotaxis) ---
                // This creates a perfect, tight packing like a real bouquet/sunflower head.

                const index = state.flowers.length;

                // 1. Distribution Settings
                const spread = 70; // Spacing between flowers
                const goldenAngle = 137.5 * (Math.PI / 180);

                // 2. Polar Coordinates
                const r = spread * Math.sqrt(index);
                const theta = index * goldenAngle;

                // 3. Cartesian Conversion (with Perspective Squash)
                // Center Point is the "Wrapper Opening" approx (600, 500)
                const centerX = 600;
                const centerY = 450;

                // X spreads naturally
                const offsetX = r * Math.cos(theta);

                // Y is squashed (0.6) to look like a tilted circle (Oval)
                // Plus we shift closer/further based on Y
                const offsetY = (r * Math.sin(theta)) * 0.7;

                // 4. Scale & Rotation Logic
                // Flowers further back (negative Y offset) should be slightly smaller?
                // Actually, random variation is better for realism.
                const randomScale = 0.85 + (Math.random() * 0.3);

                // Rotate flower based on position to "face out"
                // Flowers on left rotate left (-), right rotate right (+)
                const lookAngle = (offsetX / 400) * 0.5; // Max 0.5 rad tilt

                const newFlower = {
                    type: type,
                    price: price,
                    id: Date.now(),
                    x: centerX + offsetX,
                    y: centerY + offsetY,
                    rotation: lookAngle + (Math.random() - 0.5) * 0.2, // Add randomness
                    scale: randomScale,
                    // Sorting Metric: We want Front (High Y) on Top.
                    // But we also want the "Center" to potentially pop?
                    // Standard Painter's Algo (sort by Y) works best for 2.5D.
                };

                state.flowers.push(newFlower);
                state.price.flowers += price;
                updateUI();
                render();
            },
            reset: () => {
                state.flowers = [];
                state.price.flowers = 0;
                updateUI();
                render();
            },
            setWrapper: () => { },
            toggleAddon: () => { }
        };

        function updateUI() {
            document.getElementById('count').innerText = state.flowers.length;
            document.getElementById('flower-price').innerText = 'Rs. ' + state.price.flowers;
            document.getElementById('total-price').innerText = 'Rs. ' + (state.price.base + state.price.flowers);
        }

        function render() {
            // 1. Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 2. Background (Studio Wall)
            const grad = ctx.createRadialGradient(600, 600, 100, 600, 600, 1000);
            grad.addColorStop(0, '#f8f8f8');
            grad.addColorStop(1, '#e0e0e0');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 3. Wrapper (Base Layer)
            if (ASSETS.wrapper.img.complete) {
                const wImg = ASSETS.wrapper.img;
                ctx.shadowColor = "rgba(0,0,0,0.15)";
                ctx.shadowBlur = 40;
                ctx.shadowOffsetY = 30;
                // Draw Wrapper centered and lower down
                ctx.drawImage(wImg, 600 - (wImg.width / 2), 480);
                // ctx.shadowBlur = 0; // Keep shadow for flowers to blend? No, flowers cast shadow ON wrapper maybe?
                ctx.shadowBlur = 0;
            }

            // 4. Flowers (Sorted by Y-Coordinate)
            // Lower Y (Back) -> Drawn First
            // Higher Y (Front) -> Drawn Last
            const sortedFlowers = [...state.flowers].sort((a, b) => a.y - b.y);

            sortedFlowers.forEach(f => {
                const img = ASSETS[f.type].img;

                ctx.save();

                // Position
                ctx.translate(f.x, f.y);
                ctx.rotate(f.rotation);
                ctx.scale(f.scale, f.scale);

                // Realistic Drop Shadow (Per flower depth)
                ctx.shadowColor = "rgba(0,0,0,0.4)";
                ctx.shadowBlur = 15;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 8;

                // Draw centered
                // Asset Image Size: we assume they are large. 
                // We scale them down to drawSize.
                const drawSize = 240;
                ctx.drawImage(img, -drawSize / 2, -drawSize / 2, drawSize, drawSize);

                ctx.restore();
            });

            // 5. Front Overlay Text (Brand seal)
            ctx.font = "italic 700 30px 'Playfair Display'";
            ctx.fillStyle = "rgba(45, 76, 30, 0.4)";
            ctx.textAlign = "center";
            ctx.fillText("Himalayan Floriculture", 600, 1150);
        }



        // Tab Logic
        document.querySelectorAll('.step-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.step-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('step-' + btn.dataset.step).classList.add('active');
            });
        });

    </script>
</body>

</html>